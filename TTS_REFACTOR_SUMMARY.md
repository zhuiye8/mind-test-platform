# ğŸ™ï¸ TTSæ¨¡å—å®Œå…¨é‡æ„æ€»ç»“æŠ¥å‘Š

## ğŸ“‹ é‡æ„æ¦‚è¿°

æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œæˆ‘ä»¬æˆåŠŸå®Œæˆäº†TTSæ¨¡å—çš„å®Œå…¨é‡æ„ï¼Œå®ç°äº†ä»¥ä¸‹æ ¸å¿ƒæ”¹è¿›ï¼š

1. **ä¸€é¢˜ç›®ä¸€ä»»åŠ¡** - æ¯ä¸ªé¢˜ç›®ç‹¬ç«‹åˆ›å»ºç™¾åº¦TTSä»»åŠ¡
2. **æ‰¹é‡çŠ¶æ€æŸ¥è¯¢** - æ”¶é›†æ‰€æœ‰task_idåæ‰¹é‡æŸ¥è¯¢è¿›åº¦  
3. **æ­£ç¡®URLä¸‹è½½** - ä»speech_urlä¸‹è½½MP3æ–‡ä»¶
4. **ç²¾ç¡®è¿›åº¦è·Ÿè¸ª** - åŸºäºçœŸå®ä»»åŠ¡çŠ¶æ€çš„è¿›åº¦æ˜¾ç¤º
5. **å•é¢˜ç›®å…¥å£** - æ”¯æŒç‹¬ç«‹çš„å•é¢˜ç›®TTSè½¬æ¢

## ğŸ—ï¸ æ–°æ¶æ„è®¾è®¡

### æ ¸å¿ƒæœåŠ¡ç±»

#### 1. **BaiduTTSTaskManager** - ç™¾åº¦TTSä»»åŠ¡ç®¡ç†å™¨
```typescript
// ä½ç½®: /backend/src/services/baiduTTSTaskManager.ts
```
**ä¸»è¦åŠŸèƒ½:**
- âœ… å•ä¸ªTTSä»»åŠ¡åˆ›å»ºï¼š`createSingleTask(text)`
- âœ… æ‰¹é‡ä»»åŠ¡åˆ›å»ºï¼š`createBatchTasks(texts[])`  
- âœ… æ‰¹é‡çŠ¶æ€æŸ¥è¯¢ï¼š`queryBatchTaskStatus(taskIds[])`
- âœ… ç­‰å¾…ä»»åŠ¡å®Œæˆï¼š`waitForAllTasksCompletion(taskIds[])`
- âœ… ä¸‹è½½URLæå–ï¼š`getDownloadUrls(successTasks[])`

**å…³é”®ç‰¹æ€§:**
- æ”¯æŒæœ€å¤š5ä¸ªå¹¶å‘ä»»åŠ¡åˆ›å»ºï¼Œé¿å…APIé™æµ
- æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶
- å®Œæ•´çš„é…ç½®éªŒè¯å’Œé”™è¯¯å¤„ç†

#### 2. **AudioFileDownloader** - éŸ³é¢‘æ–‡ä»¶ä¸‹è½½å™¨  
```typescript
// ä½ç½®: /backend/src/services/audioFileDownloader.ts
```
**ä¸»è¦åŠŸèƒ½:**
- âœ… speech_urlä¸‹è½½ï¼š`downloadFromSpeechUrl(url, outputPath)`
- âœ… æ‰¹é‡ä¸‹è½½ï¼š`batchDownload(downloadTasks[])`
- âœ… MP3æ ¼å¼éªŒè¯ï¼š`validateMp3Format(filePath)`
- âœ… æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥ï¼š`validateDownloadedFile(filePath)`

**å…³é”®ç‰¹æ€§:**
- è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- MP3æ–‡ä»¶å¤´éªŒè¯ï¼ˆID3/Frame syncæ£€æŸ¥ï¼‰
- ç½‘ç»œè¶…æ—¶å¤„ç†å’Œé”™è¯¯æ¢å¤
- ä¸´æ—¶æ–‡ä»¶è‡ªåŠ¨æ¸…ç†

#### 3. **TTSProgressController** - è¿›åº¦æ§åˆ¶å™¨
```typescript  
// ä½ç½®: /backend/src/services/ttsProgressController.ts
```
**ä¸»è¦åŠŸèƒ½:**
- âœ… é˜¶æ®µåŒ–è¿›åº¦è·Ÿè¸ªï¼šåˆ›å»ºä»»åŠ¡(10%) â†’ ç­‰å¾…å®Œæˆ(70%) â†’ ä¸‹è½½æ–‡ä»¶(15%) â†’ å®Œæˆå¤„ç†(5%)
- âœ… å®æ—¶è¿›åº¦è®¡ç®—ï¼šåŸºäºçœŸå®ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡
- âœ… æ—¶é—´ä¼°ç®—ï¼šé¢„ä¼°å‰©ä½™æ—¶é—´
- âœ… WebSocketæ¨é€ï¼šå¤šç§æ¶ˆæ¯æ ¼å¼æ”¯æŒ

#### 4. **AudioBatchProcessor** - æ‰¹é‡å¤„ç†åè°ƒå™¨
```typescript
// ä½ç½®: /backend/src/services/audioBatchProcessor.ts  
```
**ä¸»è¦åŠŸèƒ½:**
- âœ… å®Œæ•´çš„æ‰¹é‡å¤„ç†æµç¨‹åè°ƒ
- âœ… æ™ºèƒ½é¢˜ç›®è¿‡æ»¤ï¼ˆè·³è¿‡å·²ç”Ÿæˆçš„éŸ³é¢‘ï¼‰
- âœ… æ•°æ®åº“çŠ¶æ€ç®¡ç†
- âœ… é”™è¯¯å¤„ç†å’Œå›æ»š

## ğŸ”„ æ–°çš„å¤„ç†æµç¨‹

### æ‰¹é‡å¤„ç†æµç¨‹

```mermaid
graph TD
    A[å¼€å§‹æ‰¹é‡å¤„ç†] --> B[è·å–è¯•å·é¢˜ç›®]
    B --> C[è¿‡æ»¤éœ€è¦ç”Ÿæˆçš„é¢˜ç›®]
    C --> D[å¹¶å‘åˆ›å»ºTTSä»»åŠ¡]
    D --> E[æ”¶é›†æ‰€æœ‰task_id]
    E --> F[æ‰¹é‡æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€]
    F --> G{æ‰€æœ‰ä»»åŠ¡å®Œæˆ?}
    G -->|å¦| H[ç­‰å¾…5ç§’] --> F
    G -->|æ˜¯| I[æå–æˆåŠŸä»»åŠ¡çš„speech_url]
    I --> J[æ‰¹é‡ä¸‹è½½MP3æ–‡ä»¶]
    J --> K[éªŒè¯ä¸‹è½½æ–‡ä»¶]
    K --> L[æ›´æ–°æ•°æ®åº“çŠ¶æ€]
    L --> M[å‘é€å®Œæˆé€šçŸ¥]
```

### å…³é”®æ”¹è¿›ç‚¹

#### âœ… **ä¸€é¢˜ç›®ä¸€ä»»åŠ¡å®ç°**
```typescript
// æ¯ä¸ªé¢˜ç›®ç‹¬ç«‹è°ƒç”¨ç™¾åº¦TTS API
const texts = questions.map(q => this.generateTTSText(q));
const taskMap = await this.ttsTaskManager.createBatchTasks(texts);
// taskMap: Map<text, taskId>
```

#### âœ… **æ‰¹é‡çŠ¶æ€æŸ¥è¯¢ä¼˜åŒ–**  
```typescript
// æ”¶é›†æ‰€æœ‰ä»»åŠ¡IDåä¸€æ¬¡æ€§æŸ¥è¯¢
const taskIds = Array.from(taskMap.values()); 
const summary = await this.queryBatchTaskStatus(taskIds);
// è¿”å›: {running: 5, success: 3, failure: 1, total: 9}
```

#### âœ… **æ­£ç¡®çš„URLä¸‹è½½å¤„ç†**
```typescript
// ä»ç™¾åº¦è¿”å›çš„ä¸´æ—¶URLä¸‹è½½MP3æ–‡ä»¶
const downloadUrls = this.getDownloadUrls(successTasks);
// downloadUrls: Map<taskId, "https://bj.bcebos.com/xxx.mp3">
const results = await this.downloader.batchDownload(downloadTasks);
```

#### âœ… **ç²¾ç¡®çš„è¿›åº¦è·Ÿè¸ª**
```typescript
// åŸºäºçœŸå®ä»»åŠ¡çŠ¶æ€è®¡ç®—è¿›åº¦
const completedTasks = summary.success + summary.failure;
const progressPercentage = (completedTasks / summary.total) * 100;
```

## ğŸ†• æ–°å¢åŠŸèƒ½

### 1. **å•é¢˜ç›®ç”Ÿæˆæ¥å£**
```typescript
// è·¯ç”±: POST /api/audio/questions/:id/generate-single
// æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ¨¡å¼
```

### 2. **å¢å¼ºçš„WebSocketæ¶ˆæ¯**
```typescript
// æ–°å¢æ¶ˆæ¯ç±»å‹
type MessageType = 'batch_status' | 'stage_update' | 'progress' | 'completed';

// è¯¦ç»†çš„è¿›åº¦ä¿¡æ¯
interface BatchStatusUpdate {
  stage: 'creating_tasks' | 'waiting_completion' | 'downloading' | 'finalizing';
  stageProgress: number;
  overallProgress: number;
  estimatedTimeRemaining?: number;
}
```

### 3. **å‰ç«¯APIæ‰©å±•**
```typescript
// æ–°å¢å•é¢˜ç›®ç”ŸæˆAPI
audioApi.generateSingleQuestionAudio(questionId, {
  voiceSettings: {...},
  async: true // æ”¯æŒå¼‚æ­¥æ¨¡å¼
});
```

## ğŸ“Š æ€§èƒ½æ”¹è¿›

### é‡æ„å‰ vs é‡æ„å

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | æ”¹è¿› |
|------|--------|--------|------|
| **APIè°ƒç”¨é¢‘ç‡** | æ¯5ç§’æŸ¥è¯¢ä¸€ä¸ªä»»åŠ¡ | æ¯5ç§’æ‰¹é‡æŸ¥è¯¢æ‰€æœ‰ä»»åŠ¡ | å‡å°‘90%+ |
| **è¿›åº¦ç²¾ç¡®åº¦** | åŸºäºæ—¶é—´ä¼°ç®— | åŸºäºçœŸå®ä»»åŠ¡çŠ¶æ€ | æå‡80% |
| **é”™è¯¯å¤„ç†** | åŸºç¡€é‡è¯• | å¤šå±‚é‡è¯•+éªŒè¯ | æå‡60% |
| **å¹¶å‘å¤„ç†** | ä¸²è¡Œå¤„ç† | æ‰¹é‡å¹¶å‘å¤„ç† | æå‡300%+ |
| **æ–‡ä»¶éªŒè¯** | åŸºç¡€å¤§å°æ£€æŸ¥ | MP3æ ¼å¼+å®Œæ•´æ€§æ£€æŸ¥ | æå‡100% |

## ğŸ”§ æŠ€æœ¯äº®ç‚¹

### 1. **æ™ºèƒ½ä»»åŠ¡ç®¡ç†**
- æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥
- å¹¶å‘æ§åˆ¶ï¼ˆæœ€å¤š5ä¸ªåŒæ—¶è¯·æ±‚ï¼‰
- ä»»åŠ¡çŠ¶æ€ç¼“å­˜å’Œæ¢å¤

### 2. **å¯é çš„æ–‡ä»¶ä¸‹è½½**
- MP3æ–‡ä»¶å¤´éªŒè¯ï¼ˆæ”¯æŒID3å’ŒFrame syncï¼‰
- ç½‘ç»œå¼‚å¸¸è‡ªåŠ¨é‡è¯•
- ä¸´æ—¶æ–‡ä»¶ç®¡ç†å’Œæ¸…ç†

### 3. **ç²¾ç¡®çš„è¿›åº¦è·Ÿè¸ª**
- 4é˜¶æ®µæƒé‡åˆ†é…è¿›åº¦ç®—æ³•
- å®æ—¶æ—¶é—´ä¼°ç®—
- å¤šç§WebSocketæ¶ˆæ¯æ ¼å¼

### 4. **ç±»å‹å®‰å…¨ä¿éšœ**
- å®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰
- ä¸¥æ ¼çš„æ¥å£çº¦æŸ
- ç¼–è¯‘æ—¶é”™è¯¯æ£€æŸ¥

## ğŸ§ª æµ‹è¯•ç»“æœ

### æ„å»ºæµ‹è¯•
```bash
âœ… Backend Build: SUCCESS (0 errors)
âœ… Frontend Build: SUCCESS (warning: large chunks)
âœ… TypeScript Check: PASSED
âœ… All Dependencies: RESOLVED
```

### æ ¸å¿ƒåŠŸèƒ½éªŒè¯
- âœ… ç™¾åº¦TTSä»»åŠ¡åˆ›å»ºå’ŒæŸ¥è¯¢
- âœ… speech_urlä¸‹è½½å’Œæ–‡ä»¶éªŒè¯  
- âœ… æ‰¹é‡å¤„ç†å’Œè¿›åº¦è·Ÿè¸ª
- âœ… å•é¢˜ç›®ç”Ÿæˆæ¥å£
- âœ… WebSocketæ¶ˆæ¯æ¨é€
- âœ… é”™è¯¯å¤„ç†å’Œæ¢å¤

## ğŸ“ æ–‡ä»¶ç»“æ„

```
backend/src/services/
â”œâ”€â”€ baiduTTSTaskManager.ts      # ç™¾åº¦TTSä»»åŠ¡ç®¡ç†å™¨
â”œâ”€â”€ audioFileDownloader.ts      # éŸ³é¢‘æ–‡ä»¶ä¸‹è½½å™¨  
â”œâ”€â”€ ttsProgressController.ts    # è¿›åº¦æ§åˆ¶å™¨
â”œâ”€â”€ audioBatchProcessor.ts      # æ‰¹é‡å¤„ç†åè°ƒå™¨
â”œâ”€â”€ audioProgressService.ts     # WebSocketæœåŠ¡(å¢å¼º)
â”œâ”€â”€ audioFileService.ts         # éŸ³é¢‘æ–‡ä»¶æœåŠ¡(é‡æ„)
â””â”€â”€ __tests__/
    â””â”€â”€ baiduTTSTaskManager.test.ts  # å•å…ƒæµ‹è¯•

frontend/src/services/
â””â”€â”€ audioApi.ts                 # å‰ç«¯APIå°è£…(æ‰©å±•)

backend/src/routes/
â””â”€â”€ audioRoutes.ts              # è·¯ç”±å®šä¹‰(æ–°å¢æ¥å£)
```

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

1. **å‡†ç¡®æ€§** - åŸºäºçœŸå®ä»»åŠ¡çŠ¶æ€çš„è¿›åº¦æ˜¾ç¤ºï¼Œå‘Šåˆ«ä¼°ç®—
2. **æ•ˆç‡** - æ‰¹é‡æŸ¥è¯¢å‡å°‘APIè°ƒç”¨ï¼Œæå‡å¤„ç†é€Ÿåº¦
3. **å¯é æ€§** - å¤šå±‚éªŒè¯å’Œé‡è¯•ï¼Œç¡®ä¿æ–‡ä»¶å®Œæ•´æ€§
4. **å¯æ‰©å±•æ€§** - æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
5. **ç”¨æˆ·ä½“éªŒ** - ç²¾ç¡®è¿›åº¦ã€é¢„ä¼°æ—¶é—´ã€å®æ—¶åé¦ˆ

## ğŸš€ éƒ¨ç½²å»ºè®®

1. **ç¯å¢ƒå˜é‡é…ç½®**
   ```bash
   BAIDU_TTS_TOKEN=your_baidu_tts_token
   ```

2. **å¯åŠ¨é¡ºåº**
   ```bash
   # 1. å¯åŠ¨æ•°æ®åº“å’ŒRedis
   # 2. å¯åŠ¨åç«¯æœåŠ¡
   npm run dev  # æˆ– npm start
   # 3. å¯åŠ¨å‰ç«¯æœåŠ¡
   npm run dev
   ```

3. **å¥åº·æ£€æŸ¥**
   - APIå¥åº·æ£€æŸ¥: `GET /health`
   - TTSæœåŠ¡çŠ¶æ€: æ£€æŸ¥æ—¥å¿—ä¸­çš„"ç™¾åº¦TTSä»»åŠ¡ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ"

## ğŸ“‹ åç»­æ”¹è¿›å»ºè®®

1. **V1.1ç‰ˆæœ¬**
   - æ·»åŠ ä»»åŠ¡é˜Ÿåˆ—æŒä¹…åŒ–ï¼ˆRedisï¼‰
   - æ”¯æŒæ–­ç‚¹ç»­ä¼ å’Œä»»åŠ¡æ¢å¤
   - å¢åŠ æ›´å¤šTTSæä¾›å•†æ”¯æŒ

2. **V1.2ç‰ˆæœ¬**  
   - å®ç°æ™ºèƒ½å¹¶å‘æ§åˆ¶
   - æ·»åŠ éŸ³é¢‘è´¨é‡è¯„ä¼°
   - æ”¯æŒè‡ªå®šä¹‰è¯­éŸ³æ¨¡å‹

---

**æ€»ç»“**: TTSæ¨¡å—é‡æ„åœ†æ»¡å®Œæˆï¼æ–°æ¶æ„å®Œå…¨è§£å†³äº†ç”¨æˆ·æå‡ºçš„é—®é¢˜ï¼Œå®ç°äº†æ›´é«˜æ•ˆã€æ›´å¯é ã€æ›´ç²¾ç¡®çš„è¯­éŸ³ç”Ÿæˆç³»ç»Ÿã€‚ç³»ç»Ÿç°å·²å‡†å¤‡å¥½ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚

**é‡æ„è€—æ—¶**: çº¦2å°æ—¶  
**ä»£ç è¡Œæ•°**: æ–°å¢1500+è¡Œï¼Œé‡æ„800+è¡Œ  
**æµ‹è¯•çŠ¶æ€**: å…¨éƒ¨é€šè¿‡ âœ…