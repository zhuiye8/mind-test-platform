# 心理测试平台 代码审查报告

> 版本：2025-08-18
> 作者：Augment Agent（基于 GPT‑5）

## 目录
- [项目概览与技术栈](#项目概览与技术栈)
- [架构与数据流](#架构与数据流)
- [API 设计与前后端一致性](#api-设计与前后端一致性)
- [Bug 与隐患清单（优先级）](#bug-与隐患清单优先级)
  - [高优先级](#高优先级)
  - [中优先级](#中优先级)
  - [低优先级](#低优先级)
- [性能优化建议](#性能优化建议)
- [代码质量改进建议](#代码质量改进建议)
- [测试与验证建议](#测试与验证建议)
- [结论与后续工作](#结论与后续工作)

---

## 项目概览与技术栈

- 仓库结构：
  - backend（Express + TypeScript + Prisma + PostgreSQL）
    - 主要入口：`backend/src/index.ts`，路由聚合：`backend/src/routes/index.ts`
    - 数据层：Prisma（`backend/prisma/schema.prisma`）
    - 中间件：认证（JWT）、错误处理、CORS/Helmet、安全头
    - 功能模块：认证、试卷/题目、考试、公开接口、AI、音频、报告、分析
  - frontend（React 19 + Vite + Ant Design 5）
    - 服务访问：`frontend/src/services/api.ts`、`audioApi.ts`、`voiceMatchService.ts`、`aiApi.ts`
    - 页面：Dashboard、Paper/Exam 列表与详情、StudentExam 等

- 运行方式：
  - 后端：`npm run dev`（ts-node + nodemon）；生产：`npm run build && npm start`
  - 数据库：PostgreSQL（`DATABASE_URL`），Prisma 迁移/生成脚本齐全
  - 前端：`vite dev`，通过 `VITE_API_BASE_URL` 指向后端 `/api`

- 第三方集成：
  - OpenRouter(OpenAI 兼容) 用于语音匹配（可降级本地匹配）
  - 百度 TTS（可降级本地模拟音频）

## 架构与数据流

- API 前缀：`/api`
  - 教师端：`/api/teacher/*`（papers, exams, analytics, ai）
  - 公开端（学生）：`/api/public/*`
  - 语音匹配：`/api/voice/*`
  - 报告：`/api/reports/*`
  - 音频文件：`/api/audio/*`

- 前端数据流：
  - 统一 axios 实例 `api.ts`，基于 `VITE_API_BASE_URL`；音频使用独立实例 `audioApi.ts`（长超时）
  - 401 处理：教师端自动跳转登录，学生端保留在原页处理错误

- 数据库模型亮点：
  - 完整的考试生命周期枚举 ExamStatus
  - 题目、量表、作答、考试、结果、情绪分析、AI 报告、题目语音 关系清晰，索引设计较充分

## API 设计与前后端一致性

- 路由挂载（`backend/src/routes/index.ts`）与前端调用基本一致：
  - 语音匹配：前端 `voiceMatchService` 调用 `/api/voice/match`（OK）
  - 音频生成/访问：`audioApi.ts` 对应后端 `audioRoutes.ts`（OK）
  - AI 教师端：`api.ts` 使用 `/api/teacher/ai/*`（OK）
  - 报告下载：后端提供 `/api/reports/generate/:examResultId`（下载文本），前端暂无对应服务方法（建议补充，见建议）

- 发现的不一致：
  1) 前端 `frontend/src/services/aiApi.ts` 使用 `/api/teacher/exam-results/${examResultId}/ai-analysis`，后端并无该端点。前端真实统一服务在 `api.ts` 的 `aiApi.generateReport` 指向 `/api/teacher/ai/exam-results/:examResultId/generate-report`。建议删除或整合 `frontend/src/services/aiApi.ts`，避免重复与误用。

## Bug 与隐患清单（优先级）

### 高优先级

1. JWT 秘钥回退默认值存在安全风险
   - 位置：`backend/src/utils/jwt.ts` 行 4
   - 问题：`JWT_SECRET` 默认 `fallback-secret-key`，生产若未设置环境变量将极易被破解。
   - 建议：生产必须强制存在 `JWT_SECRET`，缺失时启动失败；开发使用明确的 `.env` 示例。

2. LLM 模型与供应商配置硬编码且老旧
   - 位置：`backend/src/services/llmService.ts` 行 45-60
   - 问题：固定使用 `openai/gpt-3.5-turbo`（已下线/弃用），且无模型可配置性；异常处理仅降级匹配，无速率/重试策略。
   - 建议：通过环境变量配置模型与供应商；增加超时、重试、熔断；记录可观测日志字段（latency、provider、model）。

3. 报告生成服务使用 node-fetch 并固定 30s 超时，异常传播不区分可重试/不可重试
   - 位置：`backend/src/services/aiReportService.ts` 行 192-207
   - 问题：外部依赖故障时统一抛错；缺少指数退避重试；`REPORT_API_URL` 默认到 `fake_aiB`，可能误导生产。
   - 建议：使用 axios 统一超时/重试；区分 5xx/网络错误（重试）与 4xx（不重试）；默认配置改为必填。

4. 音频 TTS 目录创建 ensureDirectories 为异步但在构造函数中未 await
   - 位置：`backend/src/services/audioFileService.ts` 行 47-55, 73-82
   - 问题：`this.ensureDirectories()` 是 async，但构造函数中未 `await`，可能出现并发首次访问时目录尚未创建导致写入失败。
   - 建议：改为同步 mkdir 或在首次使用前显式 await 初始化；或在使用处捕获并二次创建。

5. 公开音频下载接口缺失 HEAD 支持但前端 `checkAudioAccess` 调用 HEAD
   - 位置：前端 `audioApi.ts` 行 206-215 调用 HEAD；后端 `audioRoutes.ts` 仅实现 GET/OPTIONS。
   - 影响：可用性检测总是失败。
   - 建议：在 `audioRoutes.ts` 增加 HEAD 路由，或前端改用 GET with Range: bytes=0-0。

### 中优先级

6. 语音匹配降级策略关键词匹配过于脆弱
   - 位置：后端 `llmService.ts` fallbackMatch；前端 `voiceMatchService.ts` localFallbackMatch
   - 问题：仅用字符串包含和固定 numberMap，对噪声/口语化不鲁棒。
   - 建议：
     - 规范化处理：全角/半角、数字中文转阿拉伯、去停用词、拼音近似匹配；
     - 引入简单的模糊匹配（如 Levenshtein 距离）并基于相似度阈值选择。

7. 报告路由与教师端 AI 路由职责重叠/混淆
   - 位置：`backend/src/routes/reportRoutes.ts` vs `/teacher/ai/*`
   - 问题：reportRoutes 直接返回文本文件下载，而 teacher/ai 更偏 JSON 状态与生成；前端缺少统一抽象，易造成重复功能。
   - 建议：统一对外 API 约定：教师端生成报告统一走 `/teacher/ai/...`，报告下载提供 `/reports/...`；前端提供统一 service。

8. PrismaClient 多实例化
   - 位置：大量服务文件直接 `new PrismaClient()`（如 `audioFileService.ts` 行 9、`aiReportService.ts` 行 4），同时 `utils/database.ts` 也导出默认 prisma。
   - 问题：多实例化在 serverless 或热重载场景易导致连接过多；难以统一事务与日志。
   - 建议：全局统一使用 `utils/database.ts` 导出的单例 prisma，移除其他 new。

9. CORS 与安全头重复设置，且对音频路径放宽策略较宽
   - 位置：`backend/src/index.ts` 行 28-58、76-101；`audioRoutes.ts` 也设置 CORS 头
   - 问题：重复设置易产生维护困难；对音频路径设置 `Access-Control-Allow-Origin: *` 与 `Allow-Credentials: true` 组合不规范。
   - 建议：集中管理 CORS；避免同时设置 `*` 与 credentials；根据需求设置精确的 origin 白名单。

10. API 错误响应格式不完全一致
   - 位置：各路由手写 res.json 或 sendError；`reportRoutes.ts` 与 `voiceRoutes.ts` 中错误字段不统一
   - 建议：统一使用 `sendSuccess`/`sendError` 工具，或统一响应结构中包含 `success, data, error, code`。

11. 资源路径拼接硬编码
   - 位置：`audioFileService.ts` 多处 `fileUrl = /api/audio/...`
   - 问题：当部署在非根路径或网关前缀变化时不易维护。
   - 建议：通过配置或 helper 统一生成 URL。

12. 代码重复：前后端都有相似的语音匹配 fallback 逻辑
   - 位置：`llmService.ts` 与 `voiceMatchService.ts`
   - 建议：将协议定义在后端，前端仅调用；必要时共享最小规则或返回提示词。

### 低优先级

13. index.ts 强制删除 HTTP(S)_PROXY 环境变量
   - 位置：`backend/src/index.ts` 行 16-23
   - 问题：在企业代理或云环境下可能破坏出网策略。
   - 建议：仅在开发环境开启，或由配置控制。

14. aiReportService.fetchExamResult 为硬编码模拟数据
   - 位置：`backend/src/services/aiReportService.ts` 行 76-114
   - 问题：生产需要真实聚合查询（ExamResult + Exam + Paper + Responses）。
   - 建议：实现 Prisma 查询，并为大数据集分页或分块处理。

15. 缺少 HEAD/Range 测试与音频类型白名单校验
   - 位置：`audioRoutes.ts`
   - 建议：HEAD 实现；校验 filename 合法性，防止路径穿越与非法扩展名。

16. 缺少统一的请求体验证
   - 问题：多数路由仅做简单空值判断。
   - 建议：引入 zod/class-validator 统一 DTO 校验，集中化错误。

17. ESLint/TS 配置未见严格规则说明
   - 建议：启用更严格规则（no-floating-promises、explicit-module-boundary-types、security 插件）。

## 性能优化建议

- 数据库层：
  - 合并 N+1 查询：在需要时使用 `include/select`，一次拉取关联数据；
  - 审视 `ExamResult` 列表统计与分页查询是否利用既有索引；
  - 对热点表（QuestionAudio）增加复合索引（status, updatedAt）以便后台轮询任务扫描。

- 后端：
  - LLM 调用与报告生成加入缓存与重试策略（如对相同 voiceText+question+options 的短期缓存）；
  - 音频生成任务并发限制与队列化，避免CPU/IO抖动；
  - 静态音频文件改用 CDN 或 Nginx 静态目录以提升 Range 请求性能。

- 前端：
  - 按需加载页面与组件；
  - 列表页面使用虚拟滚动；
  - 对音频状态聚合已提供单次聚合接口，建议前端缓存与节流轮询。

- 网络：
  - 使用 ETag/If-None-Match 缓存校验；
  - 音频文件开启长 Cache-Control 并提供版本化 URL（基于 contentHash）。

## 代码质量改进建议

- 统一错误处理：
  - 所有路由使用 `sendSuccess/sendError` 包装；
  - errorHandler 中区分已知业务错误与未知错误，返回明确 code。

- 统一日志：
  - 引入结构化日志（pino/winston），在 LLM 与外部服务调用处记录 traceId、耗时、结果摘要。

- 配置管理：
  - 使用 `config` 或 dotenv-safe，提供 `.env.example`（已有前端示例，建议后端也提供）；
  - 所有对外 URL、模型名通过环境变量配置。

- 依赖与安全：
  - 定期 `npm audit`；锁版本；对 openai、axios 指定兼容版本；
  - 在生产禁用详细错误栈回显；
  - Helmet 配置校正，避免与 CORS 冲突。

- 去重与抽象：
  - 合并 LLM fallback 逻辑到后端；
  - 提供统一的 `buildAudioUrl(questionId, filename)` helper；
  - prisma 单例化。

## 测试与验证建议

- 单元测试：
  - JWT 工具、auth 中间件；
  - llmService 的 fallback 分支；
  - audioFileService 的 hash 计算与需要更新逻辑。

- 集成测试：
  - `/api/audio/questions/:id/generate[-single]` 成功/失败路径；
  - `/api/voice/match` 在启用/未启用 LLM 下的一致性；
  - `/api/reports/generate/:examResultId?useMock=true` 下载。

- 前端端到端：
  - 登录跳转与 401 行为；
  - Paper/Exam 列表渲染与分页；
  - 学生端提交流程与音频播放检查。

- 运行命令（PowerShell 示例）：
  - 前端：`npm run dev`（frontend 目录）
  - 后端：`npm run dev`（backend 目录）
  - Prisma 迁移：`npm run db:migrate`（backend 目录）

## 结论与后续工作

- 本次审查覆盖后端主要路由与服务、前端服务与页面入口以及数据库模型。
- 优先处理高优先级项（JWT 安全、LLM/报告可配置与重试、音频目录初始化、音频 HEAD 支持、Prisma 单例化）。
- 建议建立 CI：
  - Lint + TypeCheck + 单测；
  - 后端运行最小化集成测试；
  - 构建产物与 .env 校验。

